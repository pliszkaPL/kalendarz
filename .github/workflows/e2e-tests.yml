name: E2E Tests

on:
  push:
    branches:
      - master
      - main
      - 'fix-*'
      - 'feature-*'
  pull_request:
    branches:
      - master
      - main

jobs:
  smoke-tests:
    name: Smoke Tests (Critical Path)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up hosts file
        run: |
          echo "127.0.0.1 kalendarz.loc" | sudo tee -a /etc/hosts

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, sqlite3, pdo_sqlite
          coverage: none

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install backend dependencies
        run: |
          cd backend
          composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Set up backend .env
        run: |
          cp backend/.env.example backend/.env
          sed -i 's/APP_URL=http:\/\/localhost/APP_URL=http:\/\/localhost/' backend/.env
          sed -i 's/SESSION_DRIVER=database/SESSION_DRIVER=cookie/' backend/.env
          sed -i 's/SESSION_DOMAIN=null/SESSION_DOMAIN=localhost/' backend/.env
          echo "SANCTUM_STATEFUL_DOMAINS=localhost,kalendarz.loc" >> backend/.env

      - name: Generate application key
        run: |
          cd backend
          php artisan key:generate

      - name: Run migrations
        run: |
          cd backend
          touch database/database.sqlite
          php artisan migrate --force

      - name: Start Laravel backend
        run: |
          cd backend
          php artisan serve --host=127.0.0.1 --port=8000 &
          sleep 3
          curl -f http://127.0.0.1:8000/api/health || exit 1

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Build frontend
        run: |
          cd frontend
          npm run build

      - name: Install and configure nginx
        run: |
          sudo apt-get update
          sudo apt-get install -y nginx
          sudo rm /etc/nginx/sites-enabled/default
          sudo mkdir -p /var/www/frontend
          sudo cp -r frontend/dist/* /var/www/frontend/
          sudo cp nginx.ci.conf /etc/nginx/sites-enabled/kalendarz.conf
          sudo nginx -t
          sudo systemctl restart nginx

      - name: Wait for services to be ready
        run: |
          echo "Testing backend health..."
          curl -f http://127.0.0.1:8000/api/health
          echo ""
          echo "Testing frontend through nginx..."
          timeout 30 bash -c 'until curl -f http://localhost/ 2>/dev/null | grep -q "Kalendarz"; do sleep 1; done'
          echo "Services are ready!"

      - name: Install E2E test dependencies
        run: |
          cd e2e-tests
          npm ci

      - name: Install Playwright browsers
        run: |
          cd e2e-tests
          npx playwright install chromium --with-deps

      - name: Run smoke tests
        run: |
          cd e2e-tests
          npm run test:smoke
        env:
          CI: true

      - name: Upload smoke test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-report
          path: e2e-tests/playwright-report/
          retention-days: 7

      - name: Show backend logs on failure
        if: failure()
        run: |
          echo "=== Backend Laravel log ==="
          cat backend/storage/logs/laravel.log 2>/dev/null || echo "No logs"
          echo ""
          echo "=== nginx error log ==="
          sudo cat /var/log/nginx/error.log 2>/dev/null || echo "No nginx error logs"

  full-tests:
    name: Full E2E Test Suite
    needs: smoke-tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up hosts file
        run: |
          echo "127.0.0.1 kalendarz.loc" | sudo tee -a /etc/hosts

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, sqlite3, pdo_sqlite
          coverage: none

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install backend dependencies
        run: |
          cd backend
          composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Set up backend .env
        run: |
          cp backend/.env.example backend/.env
          sed -i 's/APP_URL=http:\/\/localhost/APP_URL=http:\/\/localhost/' backend/.env
          sed -i 's/SESSION_DRIVER=database/SESSION_DRIVER=cookie/' backend/.env
          sed -i 's/SESSION_DOMAIN=null/SESSION_DOMAIN=localhost/' backend/.env
          echo "SANCTUM_STATEFUL_DOMAINS=localhost,kalendarz.loc" >> backend/.env

      - name: Generate application key
        run: |
          cd backend
          php artisan key:generate

      - name: Run migrations
        run: |
          cd backend
          touch database/database.sqlite
          php artisan migrate --force

      - name: Start Laravel backend
        run: |
          cd backend
          php artisan serve --host=127.0.0.1 --port=8000 &
          sleep 3
          curl -f http://127.0.0.1:8000/api/health || exit 1

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Build frontend
        run: |
          cd frontend
          npm run build

      - name: Install and configure nginx
        run: |
          sudo apt-get update
          sudo apt-get install -y nginx
          sudo rm /etc/nginx/sites-enabled/default
          sudo mkdir -p /var/www/frontend
          sudo cp -r frontend/dist/* /var/www/frontend/
          sudo cp nginx.ci.conf /etc/nginx/sites-enabled/kalendarz.conf
          sudo nginx -t
          sudo systemctl restart nginx

      - name: Wait for services to be ready
        run: |
          echo "Testing backend health..."
          curl -f http://127.0.0.1:8000/api/health
          echo ""
          echo "Testing frontend through nginx..."
          timeout 30 bash -c 'until curl -f http://localhost/ 2>/dev/null | grep -q "Kalendarz"; do sleep 1; done'
          echo "Services are ready!"

      - name: Install E2E test dependencies
        run: |
          cd e2e-tests
          npm ci

      - name: Install Playwright browsers
        run: |
          cd e2e-tests
          npx playwright install chromium --with-deps

      - name: Run full E2E test suite
        run: |
          cd e2e-tests
          npm test
        env:
          CI: true

      - name: Upload full test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: full-test-report
          path: e2e-tests/playwright-report/
          retention-days: 7

      - name: Show backend logs on failure
        if: failure()
        run: |
          echo "=== Backend Laravel log ==="
          cat backend/storage/logs/laravel.log 2>/dev/null || echo "No logs"
          echo ""
          echo "=== nginx error log ==="
          sudo cat /var/log/nginx/error.log 2>/dev/null || echo "No nginx error logs"
