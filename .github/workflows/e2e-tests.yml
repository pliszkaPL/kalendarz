name: E2E Tests

on:
  push:
    branches:
      - master
      - main
      - 'fix-*'
      - 'feature-*'
  pull_request:
    branches:
      - master
      - main

jobs:
  build:
    name: Build & Setup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up hosts file
        run: |
          sudo echo "127.0.0.1 kalendarz.loc" | sudo tee -a /etc/hosts

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up backend .env
        run: |
          cp backend/.env.example backend/.env
          sed -i 's/APP_URL=http:\/\/localhost/APP_URL=http:\/\/kalendarz.loc/' backend/.env
          sed -i 's/SESSION_DRIVER=database/SESSION_DRIVER=cookie/' backend/.env
          sed -i 's/SESSION_DOMAIN=null/SESSION_DOMAIN=.kalendarz.loc/' backend/.env
          echo "SANCTUM_STATEFUL_DOMAINS=kalendarz.loc,localhost:3000" >> backend/.env
          echo "FRONTEND_URL=http://kalendarz.loc" >> backend/.env

      - name: Generate application key on host (for CI)
        run: |
          cd backend
          composer install --no-interaction --prefer-dist --optimize-autoloader
          php artisan key:generate

      - name: Build and start services
        run: |
          docker compose up -d --build
        env:
          DOCKER_BUILDKIT: 1
          COMPOSE_DOCKER_CLI_BUILD: 1
          
      - name: Wait for backend to be healthy
        run: |
          echo "Waiting for backend health check..."
          timeout 120 bash -c 'until docker compose ps backend | grep -q "healthy"; do echo "Waiting for backend..."; sleep 5; done'
          
      - name: Run migrations inside container
        run: |
          docker compose exec -T backend php artisan migrate --force
          
      - name: Check services status
        run: |
          docker compose ps
          echo "=== Traefik logs ==="
          docker compose logs traefik --tail 50
          echo "=== Backend logs ==="
          docker compose logs backend --tail 50
          echo "=== Frontend logs ==="
          docker compose logs frontend --tail 50

      - name: Test backend directly (bypass Traefik)
        run: |
          echo "Testing backend directly..."
          BACKEND_IP=$(docker compose ps backend -q | xargs docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}')
          echo "Backend IP: $BACKEND_IP"
          curl -v http://$BACKEND_IP:8000/api/health || echo "Direct backend test failed"
          
      - name: Test Traefik routing
        run: |
          echo "Testing Traefik configuration..."
          curl -v http://localhost:8080/api/rawdata || echo "Traefik API not accessible"
          
      - name: Wait for services to be ready (through Traefik with Host header)
        run: |
          echo "Testing API through Traefik with Host header..."
          timeout 60 bash -c 'until curl -f -H "Host: kalendarz.loc" http://localhost/api/health 2>/dev/null; do echo "Waiting for API..."; sleep 2; done'
          echo "API is ready!"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install E2E test dependencies
        run: |
          cd e2e-tests
          npm ci

      - name: Install Playwright browsers
        run: |
          cd e2e-tests
          npx playwright install chromium --with-deps

      - name: Cleanup on failure
        if: failure()
        run: |
          echo "=== Full container logs ==="
          docker compose logs
          docker compose down -v

  smoke-tests:
    name: Smoke Tests (Critical Path)
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up hosts file
        run: |
          sudo echo "127.0.0.1 kalendarz.loc" | sudo tee -a /etc/hosts

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up backend .env
        run: |
          cp backend/.env.example backend/.env
          sed -i 's/APP_URL=http:\/\/localhost/APP_URL=http:\/\/kalendarz.loc/' backend/.env
          sed -i 's/SESSION_DRIVER=database/SESSION_DRIVER=cookie/' backend/.env
          sed -i 's/SESSION_DOMAIN=null/SESSION_DOMAIN=.kalendarz.loc/' backend/.env
          echo "SANCTUM_STATEFUL_DOMAINS=kalendarz.loc,localhost:3000" >> backend/.env
          echo "FRONTEND_URL=http://kalendarz.loc" >> backend/.env

      - name: Generate application key
        run: |
          cd backend
          composer install --no-interaction --prefer-dist --optimize-autoloader
          php artisan key:generate

      - name: Start services
        run: |
          docker compose up -d --build
        env:
          DOCKER_BUILDKIT: 1
          COMPOSE_DOCKER_CLI_BUILD: 1

      - name: Wait for backend
        run: |
          echo "Waiting for backend to be healthy..."
          timeout 120 bash -c 'until docker compose ps backend | grep -q "healthy"; do sleep 5; done'
          echo "Backend is healthy!"

      - name: Run migrations
        run: docker compose exec -T backend php artisan migrate --force

      - name: Wait for Traefik to be healthy
        run: |
          echo "Waiting for Traefik health check..."
          timeout 60 bash -c '
            while ! docker compose ps traefik | grep -q "healthy"; do
              echo "--- Traefik status ---"
              docker compose ps traefik
              echo "--- Traefik logs (last 10) ---"
              docker compose logs traefik --tail 10
              sleep 3
            done
          '
          echo "Traefik is healthy!"

      - name: Wait for frontend container to be healthy
        run: |
          echo "Waiting for frontend container health check..."
          timeout 60 bash -c '
            while ! docker compose ps frontend | grep -q "healthy"; do
              echo "--- Frontend status ---"
              docker compose ps frontend
              echo "--- Frontend logs (last 10) ---"
              docker compose logs frontend --tail 10
              sleep 3
            done
          '
          echo "Frontend container is healthy!"

      - name: Wait for Traefik to register frontend router
        run: |
          echo "Waiting for Traefik to discover frontend service..."
          timeout 120 bash -c '
            ITERATION=0
            while ! curl -s http://localhost:8080/api/http/routers 2>/dev/null | grep -q "frontend@docker"; do
              ITERATION=$((ITERATION + 1))
              echo ""
              echo "######################################################"
              echo "### ITERATION $ITERATION - $(date) ###"
              echo "######################################################"
              echo ""
              echo "=== DEBUG 1: All containers status ==="
              docker compose ps -a
              echo ""
              echo "=== DEBUG 2: Frontend container health ==="
              docker inspect $(docker compose ps -q frontend 2>/dev/null) --format "Health: {{.State.Health.Status}}, State: {{.State.Status}}" 2>/dev/null || echo "Cannot get frontend health"
              echo ""
              echo "=== DEBUG 3: Current Traefik routers ==="
              curl -s http://localhost:8080/api/http/routers 2>/dev/null || echo "Traefik API not ready"
              echo ""
              echo "=== DEBUG 4: Docker labels on frontend container ==="
              docker inspect $(docker compose ps -q frontend 2>/dev/null) --format "{{range \$k, \$v := .Config.Labels}}{{printf \"%s=%s\n\" \$k \$v}}{{end}}" 2>/dev/null | grep traefik || echo "No traefik labels or cannot inspect"
              echo ""
              echo "=== DEBUG 5: Traefik logs (errors and provider info) ==="
              docker compose logs traefik 2>&1 | grep -iE "(error|ERR|frontend|provider|docker)" | tail -30 || echo "No relevant logs"
              echo ""
              echo "=== DEBUG 6: Direct frontend connectivity test ==="
              FRONTEND_IP=$(docker inspect $(docker compose ps -q frontend 2>/dev/null) -f "{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}" 2>/dev/null)
              echo "Frontend container IP: $FRONTEND_IP"
              if [ -n "$FRONTEND_IP" ]; then
                curl -s --connect-timeout 2 http://$FRONTEND_IP:80/ | head -3 || echo "Cannot reach frontend directly"
              fi
              echo ""
              echo "--- Sleeping 5s before next iteration ---"
              sleep 5
            done
          '
          echo "Frontend router registered in Traefik!"

      - name: Wait for API health endpoint
        run: |
          echo "Testing API through Traefik..."
          timeout 60 bash -c '
            while ! curl -f -H "Host: kalendarz.loc" http://localhost/api/health 2>/dev/null; do
              echo "--- API check failed, curl verbose output ---"
              curl -v -H "Host: kalendarz.loc" http://localhost/api/health 2>&1 || true
              sleep 3
            done
          '
          echo "API is ready!"

      - name: Debug - Full diagnostic before frontend check
        if: always()
        run: |
          echo "=========================================="
          echo "=== DIAGNOSTIC STEP 1: Container Status ==="
          echo "=========================================="
          docker compose ps -a

          echo ""
          echo "=========================================="
          echo "=== DIAGNOSTIC STEP 2: Container Health ==="
          echo "=========================================="
          docker inspect --format='{{.Name}}: {{.State.Health.Status}}' $(docker compose ps -q) 2>/dev/null || echo "No health info"

          echo ""
          echo "=========================================="
          echo "=== DIAGNOSTIC STEP 3: Frontend Logs ==="
          echo "=========================================="
          docker compose logs frontend --tail 100

          echo ""
          echo "=========================================="
          echo "=== DIAGNOSTIC STEP 4: Traefik Logs ==="
          echo "=========================================="
          docker compose logs traefik --tail 50

          echo ""
          echo "=========================================="
          echo "=== DIAGNOSTIC STEP 5: Network Info ==="
          echo "=========================================="
          docker network ls
          docker network inspect kalendarz_kalendarz-network 2>/dev/null || docker network inspect $(docker network ls -q -f name=kalendarz) 2>/dev/null || echo "Network not found"

          echo ""
          echo "=========================================="
          echo "=== DIAGNOSTIC STEP 6: Test Frontend Container Directly ==="
          echo "=========================================="
          FRONTEND_CONTAINER=$(docker compose ps -q frontend)
          echo "Frontend container ID: $FRONTEND_CONTAINER"
          if [ -n "$FRONTEND_CONTAINER" ]; then
            FRONTEND_IP=$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' $FRONTEND_CONTAINER)
            echo "Frontend IP: $FRONTEND_IP"
            echo "--- Curl to frontend container directly (port 80) ---"
            curl -v --connect-timeout 5 http://$FRONTEND_IP:80/ 2>&1 || echo "Direct frontend curl failed"
          else
            echo "ERROR: Frontend container not found!"
          fi

          echo ""
          echo "=========================================="
          echo "=== DIAGNOSTIC STEP 7: Test Traefik Routing ==="
          echo "=========================================="
          echo "--- Curl to localhost with Host header ---"
          curl -v --connect-timeout 10 -H "Host: kalendarz.loc" http://localhost/ 2>&1 || echo "Traefik routing failed"

          echo ""
          echo "=========================================="
          echo "=== DIAGNOSTIC STEP 8: Traefik Router Config ==="
          echo "=========================================="
          curl -s http://localhost:8080/api/http/routers 2>/dev/null | head -200 || echo "Traefik API not accessible"

          echo ""
          echo "=========================================="
          echo "=== DIAGNOSTIC STEP 9: Traefik Services Config ==="
          echo "=========================================="
          curl -s http://localhost:8080/api/http/services 2>/dev/null | head -200 || echo "Traefik API not accessible"

          echo ""
          echo "=========================================="
          echo "=== DIAGNOSTIC STEP 10: /etc/hosts ==="
          echo "=========================================="
          cat /etc/hosts | grep kalendarz || echo "No kalendarz entry in hosts"

      - name: Wait for frontend to be ready
        run: |
          echo "Waiting for frontend to serve content..."
          timeout 90 bash -c '
            while ! curl -f -s -H "Host: kalendarz.loc" http://localhost 2>/dev/null | grep -q "<title>Kalendarz</title>"; do
              echo "=== DEBUG: curl response ==="
              curl -v -H "Host: kalendarz.loc" http://localhost 2>&1 || true
              sleep 3
            done
          '
          echo "Frontend is ready!"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install test dependencies
        run: |
          cd e2e-tests
          npm ci
          npx playwright install chromium --with-deps

      - name: Run smoke tests
        run: |
          cd e2e-tests
          npm run test:smoke
        env:
          CI: true

      - name: Upload smoke test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-report
          path: e2e-tests/playwright-report/
          retention-days: 7

      - name: Show logs on failure
        if: failure()
        run: |
          docker compose logs

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v

  full-tests:
    name: Full E2E Test Suite
    needs: smoke-tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up hosts file
        run: |
          sudo echo "127.0.0.1 kalendarz.loc" | sudo tee -a /etc/hosts

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up backend .env
        run: |
          cp backend/.env.example backend/.env
          sed -i 's/APP_URL=http:\/\/localhost/APP_URL=http:\/\/kalendarz.loc/' backend/.env
          sed -i 's/SESSION_DRIVER=database/SESSION_DRIVER=cookie/' backend/.env
          sed -i 's/SESSION_DOMAIN=null/SESSION_DOMAIN=.kalendarz.loc/' backend/.env
          echo "SANCTUM_STATEFUL_DOMAINS=kalendarz.loc,localhost:3000" >> backend/.env
          echo "FRONTEND_URL=http://kalendarz.loc" >> backend/.env

      - name: Generate application key
        run: |
          cd backend
          composer install --no-interaction --prefer-dist --optimize-autoloader
          php artisan key:generate

      - name: Start services
        run: |
          docker compose up -d --build
        env:
          DOCKER_BUILDKIT: 1
          COMPOSE_DOCKER_CLI_BUILD: 1

      - name: Wait for backend
        run: |
          echo "Waiting for backend to be healthy..."
          timeout 120 bash -c 'until docker compose ps backend | grep -q "healthy"; do sleep 5; done'
          echo "Backend is healthy!"

      - name: Run migrations
        run: docker compose exec -T backend php artisan migrate --force

      - name: Wait for Traefik to be healthy
        run: |
          echo "Waiting for Traefik health check..."
          timeout 60 bash -c '
            while ! docker compose ps traefik | grep -q "healthy"; do
              echo "--- Traefik status ---"
              docker compose ps traefik
              echo "--- Traefik logs (last 10) ---"
              docker compose logs traefik --tail 10
              sleep 3
            done
          '
          echo "Traefik is healthy!"

      - name: Wait for frontend container to be healthy
        run: |
          echo "Waiting for frontend container health check..."
          timeout 60 bash -c '
            while ! docker compose ps frontend | grep -q "healthy"; do
              echo "--- Frontend status ---"
              docker compose ps frontend
              echo "--- Frontend logs (last 10) ---"
              docker compose logs frontend --tail 10
              sleep 3
            done
          '
          echo "Frontend container is healthy!"

      - name: Wait for Traefik to register frontend router
        run: |
          echo "Waiting for Traefik to discover frontend service..."
          timeout 120 bash -c '
            ITERATION=0
            while ! curl -s http://localhost:8080/api/http/routers 2>/dev/null | grep -q "frontend@docker"; do
              ITERATION=$((ITERATION + 1))
              echo ""
              echo "######################################################"
              echo "### ITERATION $ITERATION - $(date) ###"
              echo "######################################################"
              echo ""
              echo "=== DEBUG 1: All containers status ==="
              docker compose ps -a
              echo ""
              echo "=== DEBUG 2: Frontend container health ==="
              docker inspect $(docker compose ps -q frontend 2>/dev/null) --format "Health: {{.State.Health.Status}}, State: {{.State.Status}}" 2>/dev/null || echo "Cannot get frontend health"
              echo ""
              echo "=== DEBUG 3: Current Traefik routers ==="
              curl -s http://localhost:8080/api/http/routers 2>/dev/null || echo "Traefik API not ready"
              echo ""
              echo "=== DEBUG 4: Docker labels on frontend container ==="
              docker inspect $(docker compose ps -q frontend 2>/dev/null) --format "{{range \$k, \$v := .Config.Labels}}{{printf \"%s=%s\n\" \$k \$v}}{{end}}" 2>/dev/null | grep traefik || echo "No traefik labels or cannot inspect"
              echo ""
              echo "=== DEBUG 5: Traefik logs (errors and provider info) ==="
              docker compose logs traefik 2>&1 | grep -iE "(error|ERR|frontend|provider|docker)" | tail -30 || echo "No relevant logs"
              echo ""
              echo "=== DEBUG 6: Direct frontend connectivity test ==="
              FRONTEND_IP=$(docker inspect $(docker compose ps -q frontend 2>/dev/null) -f "{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}" 2>/dev/null)
              echo "Frontend container IP: $FRONTEND_IP"
              if [ -n "$FRONTEND_IP" ]; then
                curl -s --connect-timeout 2 http://$FRONTEND_IP:80/ | head -3 || echo "Cannot reach frontend directly"
              fi
              echo ""
              echo "--- Sleeping 5s before next iteration ---"
              sleep 5
            done
          '
          echo "Frontend router registered in Traefik!"

      - name: Wait for frontend to be ready
        run: |
          echo "Waiting for frontend to serve content..."
          timeout 60 bash -c '
            while ! curl -f -s -H "Host: kalendarz.loc" http://localhost 2>/dev/null | grep -q "<title>Kalendarz</title>"; do
              echo "=== DEBUG: curl response ==="
              curl -v -H "Host: kalendarz.loc" http://localhost 2>&1 || true
              sleep 3
            done
          '
          echo "Frontend is ready!"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install test dependencies
        run: |
          cd e2e-tests
          npm ci
          npx playwright install chromium --with-deps

      - name: Run full E2E test suite
        run: |
          cd e2e-tests
          npm test
        env:
          CI: true

      - name: Upload full test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: full-test-report
          path: e2e-tests/playwright-report/
          retention-days: 7

      - name: Show logs on failure
        if: failure()
        run: |
          docker compose logs

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v
